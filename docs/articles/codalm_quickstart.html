<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>How to use codalm • codalm</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="How to use codalm">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">codalm</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/codalm_quickstart.html">How to use codalm</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/jfiksel/codalm/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>How to use codalm</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jfiksel/codalm/blob/HEAD/vignettes/codalm_quickstart.Rmd" class="external-link"><code>vignettes/codalm_quickstart.Rmd</code></a></small>
      <div class="d-none name"><code>codalm_quickstart.Rmd</code></div>
    </div>

    
    
<p>We will start by loading the <code>codalm</code> R package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jfiksel/codalm" class="external-link">codalm</a></span><span class="op">)</span></span></code></pre></div>
<p>We will now access the data from the ggtern package. We will be
analyzing how two different methods (image analysis or microscopic
inspection) estimate the composition of 30 white blood cells. The format
that we need is for both compositions to be in matrices, with one row
per observation. We will also normalize the rows of these matrices to
ensure that they sum to 1, although the <code>codalm</code> function
would also take care of this for us.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"WhiteCells"</span>, package <span class="op">=</span> <span class="st">'ggtern'</span><span class="op">)</span></span>
<span><span class="va">image</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">WhiteCells</span>, <span class="va">Experiment</span> <span class="op">==</span> <span class="st">"ImageAnalysis"</span><span class="op">)</span></span>
<span><span class="va">image_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">image</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"G"</span>, <span class="st">"L"</span>, <span class="st">"M"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">microscopic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">WhiteCells</span>, <span class="va">Experiment</span> <span class="op">==</span> <span class="st">"MicroscopicInspection"</span><span class="op">)</span></span>
<span><span class="va">microscopic_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">microscopic</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"G"</span>, <span class="st">"L"</span>, <span class="st">"M"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">image_mat</span>  <span class="op">&lt;-</span> <span class="va">image_mat</span>  <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">image_mat</span><span class="op">)</span></span>
<span><span class="va">microscopic_mat</span> <span class="op">&lt;-</span> <span class="va">microscopic_mat</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">microscopic_mat</span><span class="op">)</span></span></code></pre></div>
<p>To estimate the coefficient matrix B, we can use the
<code>codalm</code> function.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">B_est</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/codalm.html">codalm</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">microscopic_mat</span>, x <span class="op">=</span> <span class="va">image_mat</span><span class="op">)</span></span>
<span><span class="va">B_est</span></span>
<span><span class="co">#&gt;              [,1]       [,2]         [,3]</span></span>
<span><span class="co">#&gt; [1,] 9.742582e-01 0.02292755 2.814241e-03</span></span>
<span><span class="co">#&gt; [2,] 3.267625e-09 1.00000000 3.620985e-10</span></span>
<span><span class="co">#&gt; [3,] 9.484170e-18 0.04198815 9.580118e-01</span></span></code></pre></div>
<p>To see the interpretation of this matrix, please see <a href="https://doi.org/10.1111/biom.13465" class="external-link">Fiksel et al. (2022)</a>. If
all the rows of B_est are exactly the same, it is recommended to set
<code>accelerate = FALSE</code> as a sensitivity check.</p>
<p>We can also use the bootstrap to estimate 95% confidence intervals.
We will only use 50 bootstrap iterations as an example (nboot = 50), but
is recommended to do more.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">B_ci</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/codalm_ci.html">codalm_ci</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">microscopic_mat</span>, x <span class="op">=</span> <span class="va">image_mat</span>, nboot <span class="op">=</span> <span class="fl">50</span>,</span>
<span>                   conf <span class="op">=</span> <span class="fl">.95</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: package 'future' was built under R version 4.5.2</span></span>
<span><span class="va">B_ci</span><span class="op">$</span><span class="va">ci_L</span></span>
<span><span class="co">#&gt;              [,1]       [,2]         [,3]</span></span>
<span><span class="co">#&gt; [1,] 9.576089e-01 0.01399186 1.156448e-03</span></span>
<span><span class="co">#&gt; [2,] 2.512037e-15 0.97220006 9.834101e-17</span></span>
<span><span class="co">#&gt; [3,] 1.343387e-20 0.01165546 9.145955e-01</span></span>
<span><span class="va">B_ci</span><span class="op">$</span><span class="va">ci_U</span></span>
<span><span class="co">#&gt;              [,1]       [,2]         [,3]</span></span>
<span><span class="co">#&gt; [1,] 9.837854e-01 0.03981767 4.560504e-03</span></span>
<span><span class="co">#&gt; [2,] 2.779953e-02 1.00000000 4.227865e-07</span></span>
<span><span class="co">#&gt; [3,] 3.143547e-06 0.08540455 9.868145e-01</span></span></code></pre></div>
<p>These matrices given the lower and upper bounds for the confidence
interval for each element of the coefficient matrix.</p>
<p>You can also take advantage of parallelization, if you have multiple
cores available.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ncores</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span>R_FUTURE_SUPPORTSMULTICORE_UNSTABLE <span class="op">=</span> <span class="st">"quiet"</span><span class="op">)</span></span>
<span><span class="va">B_ci_parallel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/codalm_ci.html">codalm_ci</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">microscopic_mat</span>, x <span class="op">=</span> <span class="va">image_mat</span>, nboot <span class="op">=</span> <span class="fl">50</span>,</span>
<span>                   conf <span class="op">=</span> <span class="fl">.95</span>, parallel <span class="op">=</span> <span class="cn">TRUE</span>, ncpus <span class="op">=</span> <span class="va">ncores</span>, strategy <span class="op">=</span> <span class="st">'multisession'</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: package ‘future’ was built under R version 4.5.2</span></span>
<span><span class="co">#&gt; Warning: package ‘future’ was built under R version 4.5.2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">isTRUE</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">B_ci</span><span class="op">$</span><span class="va">ci_L</span>, <span class="va">B_ci_parallel</span><span class="op">$</span><span class="va">ci_L</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">isTRUE</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">B_ci</span><span class="op">$</span><span class="va">ci_U</span>, <span class="va">B_ci_parallel</span><span class="op">$</span><span class="va">ci_U</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="co"># identical(B_ci$ci_L, B_ci_parallel$ci_L)</span></span>
<span><span class="co"># identical(B_ci$ci_U, B_ci_parallel$ci_U)</span></span></code></pre></div>
<p>Finally, we will do a permutation test for linear independence.
Again, we will only do 50 permutations as an example, but in practice
this number should be higher. For demonstration purposes, we will
generate the compositional outcome independently of the compositional
predictor</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">gtools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gtools/man/dirichlet.html" class="external-link">rdirichlet</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">gtools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gtools/man/dirichlet.html" class="external-link">rdirichlet</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">indep_test_pval</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/codalm_indep_test.html">codalm_indep_test</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span>, x <span class="op">=</span> <span class="va">x</span>,</span>
<span>                                     nperms <span class="op">=</span> <span class="fl">100</span>, init.seed <span class="op">=</span> <span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">indep_test_pval</span></span>
<span><span class="co">#&gt; [1] 0.28</span></span></code></pre></div>
<p>This function can also be parallelized. Unlike the bootstrapping,
there is no need to differentiate between whether the user is using a
Windows or Unix system.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">indep_test_pval_parallel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/codalm_indep_test.html">codalm_indep_test</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span>, x <span class="op">=</span> <span class="va">x</span>,</span>
<span>                                              nperms <span class="op">=</span> <span class="fl">100</span>, init.seed <span class="op">=</span> <span class="fl">123</span>,</span>
<span>                                              parallel <span class="op">=</span> <span class="cn">TRUE</span>, ncpus <span class="op">=</span> <span class="va">ncores</span>,</span>
<span>                                              strategy <span class="op">=</span> <span class="st">'multisession'</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: package ‘future’ was built under R version 4.5.2</span></span>
<span><span class="co">#&gt; Warning: package ‘future’ was built under R version 4.5.2</span></span>
<span><span class="va">indep_test_pval_parallel</span></span>
<span><span class="co">#&gt; [1] 0.28</span></span></code></pre></div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jacob Fiksel, Sandipan Pramanik.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
